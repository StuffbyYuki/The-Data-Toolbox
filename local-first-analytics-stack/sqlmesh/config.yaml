gateways:
  duckdb:
    connection:
      type: duckdb
      catalogs:
        my_lakehouse:
          type: ducklake
          path: >-
            postgres:dbname={{ env_var('POSTGRES_DB') }}
            user={{ env_var('POSTGRES_USER') }}
            password={{ env_var('POSTGRES_PASSWORD') }}
            host={{ env_var('POSTGRES_HOST') }}
            port={{ env_var('POSTGRES_PORT', '5432') }}
            sslmode=require
          data_path: "{{ env_var('S3_BUCKET_URL') }}"

      extensions:
        - ducklake
        - postgres
        - httpfs
      secrets:
        - type: s3
          region: "{{ env_var('AWS_REGION') }}"
          key_id: "{{ env_var('AWS_ACCESS_KEY_ID') }}"
          secret: "{{ env_var('AWS_SECRET_ACCESS_KEY') }}"
          endpoint: "{{ env_var('ENDPOINT_URL') }}"

    state_connection:
      type: postgres
      host: "{{ env_var('POSTGRES_HOST') }}"
      port: "{{ env_var('POSTGRES_PORT', '5432') }}"
      user: "{{ env_var('POSTGRES_USER') }}"
      password: "{{ env_var('POSTGRES_PASSWORD') }}"
      database: "{{ env_var('POSTGRES_DB') }}"
      sslmode: "require"

default_gateway: duckdb

# --- Model Defaults ---
# https://sqlmesh.readthedocs.io/en/stable/reference/model_configuration/#model-defaults

model_defaults:
  dialect: duckdb
  start: 2025-12-19 # Start date for backfill history
  cron: '@daily'    # Run models daily at 12am UTC (can override per model)

# --- Linting Rules ---
# Enforce standards for your team
# https://sqlmesh.readthedocs.io/en/stable/guides/linter/

linter:
  enabled: true
  rules:
    - ambiguousorinvalidcolumn
    - invalidselectstarexpansion
    - noambiguousprojections

# GitHub CICD Bot Configuration
cicd_bot:
  type: github
  # Enable auto-categorization for changes
  auto_categorize_changes:
    external: full  # Never prompt the user for input, instead fall back to the most conservative category 
    python: full
    sql: full
    seed: full
  # PR environment settings
  default_pr_start: "1 week ago"
  skip_pr_backfill: false
  # Production deployment settings - DESYNCHRONIZED APPROACH 
  run_on_deploy_to_prod: false  # Disable automatic production deployments
  # Don't invalidate environment after deploy to allow for rollbacks
  invalidate_environment_after_deploy: false