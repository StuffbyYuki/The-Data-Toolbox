gateways:
  ducklake:
    connection:
      type: duckdb
      catalogs:
        lakehouse:
          type: ducklake
          # path: 'catalog.ducklake'
          path: postgres:dbname={{ env_var('POSTGRES_DB') }} user={{ env_var('POSTGRES_USER') }} password={{ env_var('POSTGRES_PASSWORD') }} host={{ env_var('POSTGRES_HOST') }} port={{ env_var('POSTGRES_PORT', '5432') }} sslmode=require
          # We use the S3 scheme for R2 because DuckDB speaks "S3-compatible" storage via httpfs.
          data_path: "{{ env_var('DUCKLAKE_DATA_PATH') }}"
          metadata_schema: "{{ env_var('DUCKLAKE_NAME') }}"

      extensions:
        - ducklake
        - httpfs
      secrets:
        # Cloudflare R2 via S3-compatible credentials.
        - type: s3
          key_id: "{{ env_var('AWS_ACCESS_KEY_ID') }}"
          secret: "{{ env_var('AWS_SECRET_ACCESS_KEY') }}"
          region: "{{ env_var('AWS_REGION', 'auto') }}"
          # R2 is S3-compatible, but DuckDB expects the endpoint as a host (no scheme).
          endpoint: "{{ env_var('R2_S3_ENDPOINT').replace('https://', '')}}"

    state_connection:
      type: postgres
      host: "{{ env_var('POSTGRES_HOST') }}"
      port: "{{ env_var('POSTGRES_PORT', '5432') }}"
      user: "{{ env_var('POSTGRES_USER') }}"
      password: "{{ env_var('POSTGRES_PASSWORD') }}"
      database: "{{ env_var('POSTGRES_DB') }}"
      sslmode: "require"

default_gateway: ducklake

# --- Model Defaults ---
# https://sqlmesh.readthedocs.io/en/stable/reference/model_configuration/#model-defaults

model_defaults:
  dialect: duckdb
  start: 2025-12-19 # Start date for backfill history
  cron: '@daily'    # Run models daily at 12am UTC (can override per model)

# --- Linting Rules ---
# Enforce standards for your team
# https://sqlmesh.readthedocs.io/en/stable/guides/linter/

linter:
  enabled: true
  rules:
    - ambiguousorinvalidcolumn
    - invalidselectstarexpansion
    - noambiguousprojections

# Add your GitHub CICD Bot Configuration
# Refer to the documentation for more details: https://sqlmesh.readthedocs.io/en/stable/integrations/github/
cicd_bot:
  type: github
  # Enable auto-categorization for changes
  auto_categorize_changes:
    external: full
    python: full
    sql: full
    seed: full
  # PR environment settings
  default_pr_start: "1 week ago"
  skip_pr_backfill: false
  # Production deployment settings - DESYNCHRONIZED APPROACH 
  run_on_deploy_to_prod: false  # Disable automatic production deployments
  # Don't invalidate environment after deploy to allow for rollbacks
  invalidate_environment_after_deploy: false