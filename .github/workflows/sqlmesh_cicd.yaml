# SQLMesh CI/CD Bot
# Make sure to set up variables in the github repo

name: SQLMesh CI/CD Bot
run-name: ðŸš€ SQLMesh Bot ðŸš€

on:
  pull_request:
    branches:
      - main
    types:
      - synchronize
      - opened
      - closed
    paths:
      - 'local-first-analytics-stack/sqlmesh/**'

# The latest commit is the one that will be used to create the PR environment and deploy to production
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

permissions:
  contents: write
  # Required to post comments
  issues: write
  # Required to update check runs
  checks: write
  # Required to merge
  pull-requests: write
  # Required for workload identity
  id-token: write

jobs:
  sqlmesh:
    name: SQLMesh CI
    runs-on: blacksmith-8vcpu-ubuntu-2404
    env:
      # Required by `local-first-analytics-stack/sqlmesh/config.yaml`
      POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
      POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
      POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
      POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}

      DUCKLAKE_DATA_PATH: ${{ secrets.DUCKLAKE_DATA_PATH }}
      DUCKLAKE_NAME: ${{ secrets.DUCKLAKE_NAME }}

      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
      R2_S3_ENDPOINT: ${{ secrets.R2_S3_ENDPOINT }}

    defaults:
      run:
        working-directory: local-first-analytics-stack
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        if: github.event.pull_request.merged == false
        with:
          ref: refs/pull/${{ github.event.issue.pull_request && github.event.issue.number || github.event.pull_request.number  }}/merge

      - name: Checkout main branch
        uses: actions/checkout@v4
        if: github.event.pull_request.merged == true
        with:
          ref: main
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install uv
          uv sync

      - name: SQLMesh Info
        run: |
          cd sqlmesh
          uv run sqlmesh info
      
      - name: SQLMesh Migrate
        run: |
          uv run sqlmesh migrate

      - name: Run SQLMesh CI/CD Bot (PR)
        if: github.event.pull_request.merged == false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          uv run sqlmesh_cicd \
            -p ${{ github.workspace }}/local-first-analytics-stack/sqlmesh \
            github --token ${{ secrets.GITHUB_TOKEN }} run-all

      - name: Deploy to Production (merge)
        if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          uv run sqlmesh_cicd \
            -p ${{ github.workspace }}/local-first-analytics-stack/sqlmesh \
            github --token ${{ secrets.GITHUB_TOKEN }} deploy-production